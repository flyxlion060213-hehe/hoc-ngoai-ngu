<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoPro - D·ªãch T·ª´ & C·ª•m T·ª´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #0f172a; font-family: 'Inter', sans-serif; color: white; height: 100vh; overflow: hidden; }
        
        /* Dropdown ch·ªØ ƒëen 100% */
        #tts-lang {
            background-color: white !important;
            color: black !important;
            border-radius: 8px; padding: 5px 10px; font-weight: bold; border: 2px solid #ef4444; outline: none;
        }
        #tts-lang option { color: black; background: white; }

        .lyric-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .source-word { 
            font-size: 1.3rem; font-weight: 700; color: #1e293b; 
            cursor: pointer; padding: 0 2px; transition: 0.1s; display: inline-block;
        }
        .source-word:hover { color: #ef4444; background: #fee2e2; border-radius: 4px; }
        
        /* Popup */
        #translate-popup {
            position: fixed; bottom: -200px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 450px; background: white; color: #1e293b; padding: 20px;
            border-radius: 25px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); 
            z-index: 1000; border: 3px solid #ef4444;
        }
        #translate-popup.active { bottom: 30px; }

        /* Quiz */
        #quiz-overlay { display: none; position: fixed; inset: 0; background: rgba(15,23,42,0.98); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .quiz-box { background: white; width: 90%; max-width: 450px; padding: 30px; border-radius: 30px; color: #1e293b; text-align: center; }
        .opt-btn { width: 100%; padding: 15px; margin-top: 10px; border: 2px solid #f1f5f9; border-radius: 15px; font-weight: 700; }
        
        #lyric-display { height: calc(100vh - 160px); overflow-y: auto; padding: 10px; }
        ::selection { background: #fecaca; color: #ef4444; } /* M√†u khi b√¥i ƒëen c·ª•m t·ª´ */
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-black italic">LINGO<span class="text-red-500">PRO</span></h1>
        <div class="flex items-center gap-2">
            <select id="tts-lang">
                <option value="en-US">English</option><option value="ko-KR">Korean</option>
                <option value="ja-JP">Japanese</option><option value="zh-CN">Chinese</option>
                <option value="fr-FR">French</option><option value="de-DE">German</option>
                <option value="es-ES">Spanish</option><option value="ru-RU">Russian</option>
                <option value="th-TH">Thai</option><option value="vi-VN">Vietnamese</option>
            </select>
            <button onclick="startQuiz()" class="bg-red-500 text-white px-4 py-2 rounded-full font-black text-xs">V√ÄO THI</button>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4 space-y-4">
            <div id="player-container" class="rounded-2xl overflow-hidden aspect-video bg-black shadow-2xl">
                <div id="player"></div>
            </div>
            <input type="text" id="yt-url" placeholder="Link Youtube..." class="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 text-white outline-none">
            <textarea id="lyric-input" rows="5" class="w-full p-3 rounded-xl bg-slate-800 border border-slate-700 text-white outline-none" placeholder="D√°n Lyrics..."></textarea>
            <button onclick="initApp()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase">üöÄ N·∫†P B√ÄI H·ªåC</button>
        </div>

        <div class="lg:col-span-8">
            <div id="lyric-display" onmouseup="handleSelection()">
                <div class="h-full flex flex-col items-center justify-center opacity-20">
                    <p class="text-xl font-bold">B·∫•m v√†o t·ª´ ho·∫∑c b√¥i ƒëen c·ª•m t·ª´ ƒë·ªÉ d·ªãch!</p>
                </div>
            </div>
        </div>
    </div>

    <div id="translate-popup">
        <div class="flex-1 min-w-0">
            <p id="pop-src" class="text-[10px] font-black text-slate-400 uppercase truncate">WORD/PHRASE</p>
            <p id="pop-vi" class="text-xl font-black text-red-600 leading-tight">D·ªãch...</p>
        </div>
        <button onclick="speak()" class="w-12 h-12 bg-red-500 text-white rounded-full flex items-center justify-center shadow-lg ml-4">
            <i class="fa-solid fa-volume-high"></i>
        </button>
    </div>

    <div id="quiz-overlay">
        <div class="quiz-box shadow-2xl">
            <div id="quiz-content">
                <h2 id="quiz-question" class="text-3xl font-black mb-8">Word</h2>
                <div id="quiz-options"></div>
            </div>
            <div id="quiz-result" class="hidden">
                <h2 class="text-6xl font-black text-blue-600 mb-6" id="quiz-score">0/10</h2>
                <button onclick="closeQuiz()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">ƒê√ìNG</button>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player, popupTimer, learnedList = [], quizWords = [], currentQ = 0, score = 0;

        function extractId(url) {
            const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (m && m[2].length == 11) ? m[2] : false;
        }

        async function translate(text) {
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=vi&dt=t&q=${encodeURIComponent(text)}`);
                const data = await res.json();
                return data[0][0][0];
            } catch (e) { return "L·ªói d·ªãch"; }
        }

        function initApp() {
            const lyrics = document.getElementById('lyric-input').value;
            const ytUrl = document.getElementById('yt-url').value;
            const vid = extractId(ytUrl);
            if(vid) {
                if(player) player.loadVideoById(vid);
                else player = new YT.Player('player', { videoId: vid, width: '100%', height: '100%' });
            }
            render(lyrics);
        }

        function render(text) {
            const container = document.getElementById('lyric-display');
            container.innerHTML = "";
            text.split('\n').filter(l => l.trim()).forEach(line => {
                const card = document.createElement('div');
                card.className = 'lyric-card';
                line.split(/(\s+)/).forEach(token => {
                    if(/\s+/.test(token)) {
                        card.appendChild(document.createTextNode(token));
                    } else {
                        const span = document.createElement('span');
                        span.className = 'source-word';
                        span.innerText = token;
                        span.onclick = (e) => {
                            // Ch·ªâ d·ªãch t·ª´ n·∫øu kh√¥ng c√≥ vƒÉn b·∫£n n√†o ƒëang ƒë∆∞·ª£c b√¥i ƒëen
                            if (window.getSelection().toString().length === 0) {
                                const clean = token.replace(/[.,!?;:'"‚Äú‚Äù]/g, "");
                                showPopup(clean);
                            }
                        };
                        card.appendChild(span);
                    }
                });
                container.appendChild(card);
            });
        }

        // CH·ª®C NƒÇNG D·ªäCH C·ª§M T·ª™ (B√îI ƒêEN)
        async function handleSelection() {
            const selectedText = window.getSelection().toString().trim();
            if (selectedText.length > 0) {
                showPopup(selectedText);
            }
        }

        async function showPopup(text) {
            const pop = document.getElementById('translate-popup');
            document.getElementById('pop-src').innerText = text;
            document.getElementById('pop-vi').innerText = "ƒêang tra...";
            pop.classList.add('active');

            const result = await translate(text);
            document.getElementById('pop-vi').innerText = result;

            if(!learnedList.find(i => i.q === text)) learnedList.push({q: text, a: result});
            
            if(popupTimer) clearTimeout(popupTimer);
            popupTimer = setTimeout(() => pop.classList.remove('active'), 6000);
        }

        function speak() {
            const txt = document.getElementById('pop-src').innerText;
            const utter = new SpeechSynthesisUtterance(txt);
            utter.lang = /[\uAC00-\uD7A3]/.test(txt) ? 'ko-KR' : document.getElementById('tts-lang').value;
            window.speechSynthesis.speak(utter);
        }

        /* --- QUIZ LOGIC --- */
        function startQuiz() {
            if(learnedList.length < 4) return alert("Tra √≠t nh·∫•t 4 t·ª´/c·ª•m ƒë·ªÉ thi!");
            quizWords = [...learnedList].sort(() => 0.5 - Math.random()).slice(0, 10);
            currentQ = 0; score = 0;
            document.getElementById('quiz-overlay').style.display = 'flex';
            document.getElementById('quiz-content').classList.remove('hidden');
            document.getElementById('quiz-result').classList.add('hidden');
            showQuestion();
        }

        function showQuestion() {
            if(currentQ >= quizWords.length) {
                document.getElementById('quiz-content').classList.add('hidden');
                document.getElementById('quiz-result').classList.remove('hidden');
                document.getElementById('quiz-score').innerText = `${score}/${quizWords.length}`;
                return;
            }
            const item = quizWords[currentQ];
            document.getElementById('quiz-question').innerText = item.q;
            let opts = [item.a];
            let pool = learnedList.filter(i => i.a !== item.a);
            while(opts.length < 4 && pool.length > 0) {
                let r = pool[Math.floor(Math.random()*pool.length)].a;
                if(!opts.includes(r)) opts.push(r);
            }
            const container = document.getElementById('quiz-options');
            container.innerHTML = "";
            opts.sort(() => 0.5 - Math.random()).forEach(o => {
                const b = document.createElement('button');
                b.className = 'opt-btn'; b.innerText = o;
                b.onclick = () => { if(o === item.a) score++; currentQ++; showQuestion(); };
                container.appendChild(b);
            });
        }
        function closeQuiz() { document.getElementById('quiz-overlay').style.display = 'none'; }
    </script>
</body>
</html>
