<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoPro - Reverse Search & Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/korean-romanization@1.0.11/dist/korean-romanization.min.js"></script>
    <style>
        body { background: #f8fafc; color: #1e293b; font-family: system-ui, sans-serif; }
        .word-wrapper { display: inline-flex; flex-direction: column; margin: 0 4px 10px 0; cursor: pointer; border-radius: 8px; padding: 2px; }
        .word-hangul { font-size: 1.25rem; font-weight: 600; transition: 0.2s; }
        .word-romaji { font-size: 0.7rem; color: #94a3b8; margin-top: -2px; }
        
        /* Highlight khi tra ng∆∞·ª£c */
        .highlight-korean { color: #ef4444 !important; transform: scale(1.1); font-weight: 800; }
        
        .vi-word { cursor: pointer; padding: 0 2px; transition: 0.2s; border-bottom: 1px dashed #cbd5e1; }
        .vi-word:hover { color: #ef4444; border-bottom-color: #ef4444; }

        .lyric-card { background: white; padding: 1.5rem; border-radius: 1.2rem; margin-bottom: 1rem; border: 1px solid #e2e8f0; }
        
        /* Quiz Styles */
        #quiz-container { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .quiz-option { width: 100%; max-width: 400px; padding: 15px; margin: 5px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .quiz-option:hover { border-color: #3b82f6; background: #eff6ff; }
    </style>
</head>
<body class="p-4 lg:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black text-slate-800 tracking-tighter">LINGO<span class="text-red-500">QUIZ</span></h1>
            <button onclick="startQuiz()" class="bg-red-500 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-red-600 transition">L√ÄM TR·∫ÆC NGHI·ªÜM</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-4">
                <div class="aspect-video bg-black rounded-2xl overflow-hidden" id="player"></div>
                <div class="bg-white p-6 rounded-2xl border shadow-sm">
                    <input type="text" id="videoUrl" placeholder="Link YouTube..." class="w-full mb-3 p-3 bg-slate-50 rounded-xl border outline-none focus:ring-1 focus:ring-red-400">
                    <textarea id="rawLyrics" rows="4" placeholder="D√°n l·ªùi ti·∫øng H√†n..." class="w-full p-3 bg-slate-50 rounded-xl border outline-none text-sm"></textarea>
                    <button onclick="processLyrics()" class="w-full mt-2 bg-slate-900 text-white py-3 rounded-xl font-bold">N·∫†P B√ÄI H·ªåC</button>
                </div>
            </div>

            <div id="lyricsContent" class="h-[650px] overflow-y-auto pr-2">
                </div>
        </div>
    </div>

    <div id="quiz-container">
        <div id="quiz-content" class="w-full max-w-xl text-center">
            <h2 class="text-3xl font-bold mb-8" id="quiz-question">T·ª´ n√†y nghƒ©a l√† g√¨?</h2>
            <div id="quiz-word" class="text-5xl font-black text-red-500 mb-10">...</div>
            <div id="quiz-options" class="flex flex-col items-center"></div>
            <button onclick="closeQuiz()" class="mt-10 text-slate-400 underline">Tho√°t tr·∫Øc nghi·ªám</button>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player, quizData = [];

        function processLyrics() {
            const url = document.getElementById('videoUrl').value;
            const text = document.getElementById('rawLyrics').value;
            const id = extractId(url);
            if (!id || !text) return;

            if (player) player.loadVideoById(id);
            else player = new YT.Player('player', { videoId: id });

            const lines = text.split('\n').filter(l => l.trim());
            const container = document.getElementById('lyricsContent');
            container.innerHTML = "";
            quizData = []; // Reset d·ªØ li·ªáu tr·∫Øc nghi·ªám

            lines.forEach((line, i) => {
                const card = document.createElement('div');
                card.className = 'lyric-card';
                card.innerHTML = `
                    <div class="flex flex-wrap mb-4" id="ko-line-${i}"></div>
                    <div class="vi-line text-slate-500 pt-3 border-t border-slate-50" id="vi-line-${i}">ƒêang d·ªãch...</div>
                `;
                container.appendChild(card);
                renderLine(line, i);
            });
        }

        async function renderLine(line, i) {
            const words = line.split(/\s+/);
            const koContainer = document.getElementById(`ko-line-${i}`);
            
            // Render t·ª´ H√†n
            words.forEach((w, j) => {
                const romaji = typeof kroman !== 'undefined' ? kroman.parse(w) : '';
                koContainer.innerHTML += `
                    <div class="word-wrapper" id="ko-${i}-${j}">
                        <span class="word-hangul text-slate-700">${w}</span>
                        <span class="word-romaji">${romaji}</span>
                    </div>`;
            });

            // D·ªãch v√† Render t·ª´ Vi·ªát (ƒë·ªÉ tra ng∆∞·ª£c)
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=ko&tl=vi&dt=t&q=${encodeURI(line)}`);
                const data = await res.json();
                const viText = data[0][0][0];
                const viWords = viText.split(/\s+/);

                const viContainer = document.getElementById(`vi-line-${i}`);
                viContainer.innerHTML = viWords.map(vw => `<span class="vi-word" onclick="reverseSearch('${vw}', ${i})">${vw}</span>`).join(' ');
            } catch (e) { console.error(e); }
        }

        // TRA NG∆Ø·ª¢C: Nh·∫•n ti·∫øng Vi·ªát -> Highlight ti·∫øng H√†n
        async function reverseSearch(viWord, lineIdx) {
            // Reset t·∫•t c·∫£ highlight
            document.querySelectorAll('.word-hangul').forEach(el => el.classList.remove('highlight-korean'));
            
            try {
                // Tra ng∆∞·ª£c t·ª´ Vi·ªát sang H√†n
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=vi&tl=ko&dt=t&q=${encodeURI(viWord)}`);
                const data = await res.json();
                const koEquivalent = data[0][0][0];

                // L∆∞u v√†o d·ªØ li·ªáu tr·∫Øc nghi·ªám
                if(!quizData.find(item => item.ko === koEquivalent)) {
                    quizData.push({ ko: koEquivalent, vi: viWord });
                }

                // T√¨m v√† highlight t·ª´ H√†n trong d√≤ng ƒë√≥
                const koWords = document.querySelectorAll(`#ko-line-${lineIdx} .word-hangul`);
                koWords.forEach(el => {
                    if (el.innerText.includes(koEquivalent) || koEquivalent.includes(el.innerText)) {
                        el.classList.add('highlight-korean');
                    }
                });
            } catch (e) { alert("Kh√¥ng t√¨m th·∫•y t·ª´ t∆∞∆°ng ·ª©ng!"); }
        }

        // H·ªÜ TH·ªêNG TR·∫ÆC NGHI·ªÜM
        function startQuiz() {
            if (quizData.length < 2) return alert("H√£y nh·∫•n v√†o v√†i t·ª´ ti·∫øng Vi·ªát ƒë·ªÉ h·ªá th·ªëng h·ªçc t·ª´ v·ª±ng tr∆∞·ªõc khi l√†m tr·∫Øc nghi·ªám!");
            document.getElementById('quiz-container').style.display = 'flex';
            nextQuestion();
        }

        function nextQuestion() {
            const correct = quizData[Math.floor(Math.random() * quizData.length)];
            const options = [correct.vi];
            
            while(options.length < 3 && options.length < quizData.length) {
                const randomVi = quizData[Math.floor(Math.random() * quizData.length)].vi;
                if(!options.includes(randomVi)) options.push(randomVi);
            }
            options.sort(() => Math.random() - 0.5);

            document.getElementById('quiz-word').innerText = correct.ko;
            const optContainer = document.getElementById('quiz-options');
            optContainer.innerHTML = options.map(opt => `
                <div class="quiz-option" onclick="checkAnswer('${opt}', '${correct.vi}')">${opt}</div>
            `).join('');
        }

        function checkAnswer(selected, correct) {
            if(selected === correct) {
                alert("Ch√≠nh x√°c! üéâ");
                nextQuestion();
            } else {
                alert("Sai r·ªìi, th·ª≠ l·∫°i nh√©!");
            }
        }

        function closeQuiz() { document.getElementById('quiz-container').style.display = 'none'; }
        function extractId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length == 11) ? match[2] : false;
        }
    </script>
</body>
</html>
