<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoPro Ultra v3.0 | Secure Language Learning</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --bg-dark: #0b0f1a;
            --card-bg: rgba(22, 28, 45, 0.7);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: radial-gradient(circle at top right, #1e1b4b, #0b0f1a);
            color: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }

        /* Glassmorphism */
        .glass { background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-hover:hover { background: rgba(255,255,255,0.1); border-color: var(--primary); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* Animations */
        .word-glow:hover { text-shadow: 0 0 10px var(--primary); color: white; transform: scale(1.1); }
        .btn-gradient { background: linear-gradient(135deg, var(--primary), var(--secondary)); transition: all 0.3s; }
        .btn-gradient:hover { filter: brightness(1.2); transform: translateY(-2px); box-shadow: 0 10px 20px -10px var(--primary); }

        /* Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 320px 1fr 300px;
            height: calc(100vh - 64px);
        }

        #video-player-wrapper {
            position: relative;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 5000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }

        .shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    </style>
</head>
<body>

    <div id="app-loader" class="fixed inset-0 z-[9999] bg-slate-950 flex flex-col items-center justify-center">
        <div class="w-20 h-20 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-6"></div>
        <h1 class="text-2xl font-black tracking-widest text-white italic">LINGOPRO <span class="text-indigo-500">ULTRA</span></h1>
        <p class="text-slate-500 text-xs mt-2 uppercase font-bold tracking-widest">Securing environment...</p>
    </div>

    <nav class="h-16 border-b border-white/5 px-6 flex items-center justify-between glass z-40">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i class="fa-solid fa-bolt-lightning text-white"></i>
            </div>
            <div class="leading-none">
                <h1 class="text-lg font-black tracking-tighter">LINGOPRO <span class="text-indigo-500 text-xs">V3.0</span></h1>
                <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Professional Learning Space</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div id="guest-zone" class="flex gap-2">
                <button onclick="ui.toggleModal('auth-modal', 'login')" class="px-4 py-2 text-xs font-bold hover:text-indigo-400 transition">LOGIN</button>
                <button onclick="ui.toggleModal('auth-modal', 'signup')" class="px-5 py-2 text-xs font-black bg-white text-black rounded-lg hover:bg-indigo-500 hover:text-white transition">GET STARTED</button>
            </div>
            <div id="user-zone" class="hidden flex items-center gap-4 border-l border-white/10 pl-4">
                <div class="text-right">
                    <p id="nav-username" class="text-xs font-black text-indigo-400 uppercase tracking-tighter"></p>
                    <p id="user-rank" class="text-[8px] text-slate-500 font-bold uppercase">Beginner Learner</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center overflow-hidden">
                    <img id="nav-avatar" src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff" alt="avatar">
                </div>
                <button onclick="auth.logout()" class="text-slate-500 hover:text-red-500 transition"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="ui.toggleModal('stats-modal')" class="w-10 h-10 rounded-xl glass-hover flex items-center justify-center transition" title="Statistics"><i class="fa-solid fa-chart-pie text-xs"></i></button>
            <button onclick="ui.toggleModal('settings-modal')" class="w-10 h-10 rounded-xl glass-hover flex items-center justify-center transition" title="Settings"><i class="fa-solid fa-sliders text-xs"></i></button>
            <button onclick="app.openQuiz()" class="btn-gradient px-6 py-2.5 rounded-xl font-black text-[10px] tracking-widest shadow-lg">TEST SKILLS</button>
        </div>
    </nav>

    <main class="main-grid">
        
        <aside class="p-5 border-r border-white/5 space-y-6 overflow-y-auto bg-black/20">
            <section>
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-play text-indigo-500"></i> Media Engine
                </h3>
                <div class="glass p-4 rounded-2xl space-y-4">
                    <div id="video-player-wrapper" class="shimmer">
                        <div id="player"></div>
                    </div>
                    <div class="relative">
                        <input type="text" id="yt-url" placeholder="YouTube URL..." class="w-full bg-slate-900/50 border border-white/5 rounded-xl px-4 py-3 text-xs outline-none focus:border-indigo-500 transition">
                        <i class="fa-brands fa-youtube absolute right-4 top-3.5 text-slate-600"></i>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-file-lines text-indigo-500"></i> Source Lyrics
                </h3>
                <div class="glass p-4 rounded-2xl">
                    <textarea id="lyric-input" rows="12" placeholder="Paste your lyrics or text here to start processing..." class="w-full bg-transparent border-none text-xs leading-relaxed outline-none resize-none mb-4 custom-scroll"></textarea>
                    <button id="process-btn" class="w-full py-4 bg-indigo-600/10 hover:bg-indigo-600 border border-indigo-500/30 rounded-xl text-indigo-400 hover:text-white font-black text-[10px] uppercase tracking-widest transition-all">
                        Process Session
                    </button>
                </div>
            </section>
        </aside>

        <section class="flex flex-col relative">
            <div class="px-10 py-4 border-b border-white/5 flex justify-between items-center bg-black/10">
                <div class="flex items-center gap-4">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Language Focus</span>
                    <select id="target-lang" class="bg-indigo-600/20 text-indigo-400 text-[10px] font-black px-3 py-1 rounded-full outline-none border border-indigo-500/20">
                        <option value="vi">VIETNAMESE</option>
                        <option value="en">ENGLISH</option>
                        <option value="fr">FRENCH</option>
                        <option value="ko">KOREAN</option>
                        <option value="ja">JAPANESE</option>
                    </select>
                </div>
                <div class="text-[10px] text-slate-500 font-bold">
                    <span id="reading-time">0</span> MIN READ
                </div>
            </div>

            <div id="lyric-display" class="flex-1 overflow-y-auto px-16 py-12 space-y-4 text-xl font-medium leading-loose">
                <div class="h-full flex flex-col items-center justify-center text-center opacity-30">
                    <i class="fa-solid fa-laptop-code text-6xl mb-6"></i>
                    <h2 class="text-2xl font-black uppercase italic">Engine Ready</h2>
                    <p class="text-sm">Input data to begin interactive learning</p>
                </div>
            </div>

            <div id="translation-popup" class="glass border-t-4 border-indigo-500 p-8 rounded-3xl shadow-2xl">
                <div class="flex justify-between items-start">
                    <div class="space-y-1">
                        <p id="pop-src" class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.3em]"></p>
                        <h2 id="pop-vi" class="text-4xl font-black tracking-tighter"></h2>
                        <p id="pop-example" class="text-xs text-slate-500 italic mt-2">Click to save this word to your notebook.</p>
                    </div>
                    <div class="flex flex-col gap-3">
                        <button onclick="app.speak()" class="w-14 h-14 rounded-2xl bg-indigo-600/10 hover:bg-indigo-600 text-indigo-400 hover:text-white flex items-center justify-center transition-all shadow-xl">
                            <i class="fa-solid fa-volume-high text-lg"></i>
                        </button>
                        <button onclick="app.saveVocab()" class="w-14 h-14 rounded-2xl bg-pink-600/10 hover:bg-pink-600 text-pink-400 hover:text-white flex items-center justify-center transition-all shadow-xl">
                            <i class="fa-solid fa-bookmark text-lg"></i>
                        </button>
                    </div>
                </div>
                <button onclick="ui.closePopup()" class="mt-8 text-[10px] font-black text-slate-600 hover:text-white uppercase tracking-widest">Close Discovery</button>
            </div>
        </section>

        <aside class="p-5 border-l border-white/5 flex flex-col bg-black/20 overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Notebook</h3>
                <span id="vocab-count" class="bg-indigo-500 text-white text-[9px] px-2 py-0.5 rounded-full font-black">0</span>
            </div>
            
            <div id="notebook-list" class="flex-1 overflow-y-auto space-y-3 pr-2">
                </div>

            <div class="mt-4 pt-4 border-t border-white/5">
                <button onclick="app.exportData()" class="w-full py-3 bg-slate-900 hover:bg-slate-800 rounded-xl text-[10px] font-bold text-slate-400 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-export"></i> BACKUP DATA (JSON)
                </button>
            </div>
        </aside>
    </main>

    <div id="auth-modal" class="modal">
        <div class="glass p-10 rounded-[32px] w-full max-w-md shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-pink-500 to-indigo-500"></div>
            
            <div id="auth-login">
                <h2 class="text-3xl font-black mb-2 italic">WELCOME BACK</h2>
                <p class="text-xs text-slate-500 mb-8 uppercase font-bold tracking-widest">Enter security credentials</p>
                <div class="space-y-4">
                    <input type="text" id="l-user" placeholder="Username" class="w-full bg-slate-900 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-indigo-500 transition">
                    <input type="password" id="l-pass" placeholder="Password" class="w-full bg-slate-900 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-indigo-500 transition">
                    <button onclick="auth.login()" class="w-full btn-gradient py-4 rounded-2xl font-black text-sm tracking-widest uppercase mt-4">Establish Session</button>
                </div>
                <p class="text-center text-xs text-slate-500 mt-6">No account? <button onclick="ui.toggleAuthMode('signup')" class="text-indigo-400 font-black">Create Identity</button></p>
            </div>

            <div id="auth-signup" class="hidden">
                <h2 class="text-3xl font-black mb-2 italic text-pink-500">NEW IDENTITY</h2>
                <p class="text-xs text-slate-500 mb-8 uppercase font-bold tracking-widest">Password will be SHA-256 encrypted</p>
                <div class="space-y-4">
                    <input type="text" id="s-user" placeholder="Choose Username" class="w-full bg-slate-900 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-pink-500 transition">
                    <input type="password" id="s-pass" placeholder="Secure Password" class="w-full bg-slate-900 border border-white/5 rounded-2xl px-6 py-4 outline-none focus:border-pink-500 transition">
                    <button onclick="auth.signup()" class="w-full bg-pink-600 py-4 rounded-2xl font-black text-sm tracking-widest uppercase mt-4">Create Account</button>
                </div>
                <p class="text-center text-xs text-slate-500 mt-6">Already have ID? <button onclick="ui.toggleAuthMode('login')" class="text-pink-400 font-black">Back to Login</button></p>
            </div>

            <button onclick="ui.closeModal('auth-modal')" class="absolute top-6 right-6 text-slate-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <div id="stats-modal" class="modal">
        <div class="glass p-10 rounded-[40px] w-full max-w-2xl shadow-2xl">
            <h2 class="text-2xl font-black mb-8 italic flex items-center gap-3">
                <i class="fa-solid fa-chart-line text-indigo-500"></i> LEARNING ANALYTICS
            </h2>
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="glass p-6 rounded-3xl text-center">
                    <p class="text-[10px] font-black text-slate-500 uppercase">Words Learned</p>
                    <p id="stat-total" class="text-4xl font-black text-indigo-500">0</p>
                </div>
                <div class="glass p-6 rounded-3xl text-center">
                    <p class="text-[10px] font-black text-slate-500 uppercase">Rank</p>
                    <p id="stat-rank" class="text-xl font-black text-pink-500 mt-2">NOVICE</p>
                </div>
                <div class="glass p-6 rounded-3xl text-center">
                    <p class="text-[10px] font-black text-slate-500 uppercase">Efficiency</p>
                    <p class="text-4xl font-black text-emerald-500">100%</p>
                </div>
            </div>
            <div class="h-64 glass p-6 rounded-3xl">
                <canvas id="mainChart"></canvas>
            </div>
            <button onclick="ui.closeModal('stats-modal')" class="w-full mt-8 py-4 bg-slate-800 rounded-2xl font-black text-xs tracking-widest uppercase">Return to Study</button>
        </div>
    </div>

    <div id="quiz-modal" class="modal">
        <div class="glass p-12 rounded-[40px] w-full max-w-xl shadow-2xl text-center">
            <div id="quiz-intro">
                <i class="fa-solid fa-brain text-6xl text-indigo-500 mb-6"></i>
                <h2 class="text-3xl font-black mb-2 italic">NEURAL TEST</h2>
                <p class="text-slate-500 mb-8">Ready to challenge your memory?</p>
                <button onclick="app.startQuiz()" class="btn-gradient px-12 py-5 rounded-2xl font-black text-sm tracking-widest uppercase shadow-xl">Start Assessment</button>
            </div>
            <div id="quiz-engine" class="hidden">
                <div class="flex justify-between items-center mb-10 text-[10px] font-black text-slate-500">
                    <span id="quiz-progress">QUESTION 1/10</span>
                    <span id="quiz-score">SCORE: 0</span>
                </div>
                <h3 id="quiz-q-word" class="text-5xl font-black mb-12 tracking-tighter">WORD</h3>
                <div id="quiz-options" class="grid grid-cols-2 gap-4">
                    </div>
            </div>
            <button onclick="ui.closeModal('quiz-modal')" class="mt-10 text-[10px] font-black text-slate-700 hover:text-white uppercase tracking-widest">Terminate Session</button>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        /**
         * LINGOPRO ENGINE CORE
         * @namespace State Management & Configuration
         */
        const CONFIG = {
            VERSION: '3.0.0',
            HASH_KEY: 'lingopro_secret_salt_2024',
            RANKS: ['NOVICE', 'EXPLORER', 'SCHOLAR', 'LINGUIST', 'MASTER']
        };

        let state = {
            user: JSON.parse(localStorage.getItem('lingopro_session')) || null,
            notebook: [],
            currentWord: null,
            chart: null,
            quiz: {
                active: false,
                current: null,
                score: 0,
                index: 0
            }
        };

        /**
         * UI CONTROLLER
         * @namespace Handles all DOM manipulations and GSAP animations
         */
        const ui = {
            init() {
                this.updateAuthState();
                setTimeout(() => {
                    gsap.to("#app-loader", { opacity: 0, pointerEvents: 'none', duration: 1 });
                }, 1500);
            },

            updateAuthState() {
                const guest = document.getElementById('guest-zone');
                const userZone = document.getElementById('user-zone');
                
                if(state.user) {
                    guest.classList.add('hidden');
                    userZone.classList.remove('hidden');
                    document.getElementById('nav-username').innerText = state.user.username;
                    document.getElementById('nav-avatar').src = `https://ui-avatars.com/api/?name=${state.user.username}&background=6366f1&color=fff&bold=true`;
                    this.loadUserContent();
                } else {
                    guest.classList.remove('hidden');
                    userZone.classList.add('hidden');
                }
            },

            loadUserContent() {
                const db = JSON.parse(localStorage.getItem('lingopro_db') || '[]');
                const userData = db.find(u => u.username === state.user.username);
                if(userData) {
                    state.notebook = userData.vocab;
                    this.renderNotebook();
                    this.updateRank(state.notebook.length);
                }
            },

            toggleModal(id, mode = 'login') {
                const modal = document.getElementById(id);
                modal.style.display = 'flex';
                gsap.to(modal, { opacity: 1, duration: 0.4 });
                
                if(id === 'auth-modal') this.toggleAuthMode(mode);
                if(id === 'stats-modal') app.initStats();
            },

            closeModal(id) {
                gsap.to(`#${id}`, { opacity: 0, duration: 0.3, onComplete: () => {
                    document.getElementById(id).style.display = 'none';
                }});
            },

            toggleAuthMode(mode) {
                const login = document.getElementById('auth-login');
                const signup = document.getElementById('auth-signup');
                if(mode === 'login') {
                    login.classList.remove('hidden');
                    signup.classList.add('hidden');
                } else {
                    login.classList.add('hidden');
                    signup.classList.remove('hidden');
                }
            },

            showPopup() {
                gsap.to("#translation-popup", { bottom: 40, duration: 0.6, ease: "back.out(1.7)" });
            },

            closePopup() {
                gsap.to("#translation-popup", { bottom: -500, duration: 0.4 });
            },

            renderNotebook() {
                const list = document.getElementById('notebook-list');
                document.getElementById('vocab-count').innerText = state.notebook.length;
                
                list.innerHTML = state.notebook.map((item, idx) => `
                    <div class="glass p-4 rounded-2xl flex justify-between items-center group glass-hover transition-all">
                        <div>
                            <p class="text-indigo-400 font-black text-[10px] uppercase tracking-widest">${item.src}</p>
                            <p class="text-sm font-bold text-white">${item.vi}</p>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="app.speakText('${item.src}')" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-indigo-600 flex items-center justify-center transition"><i class="fa-solid fa-volume-high text-[10px]"></i></button>
                            <button onclick="app.deleteVocab(${idx})" class="w-8 h-8 rounded-lg bg-slate-800 hover:bg-red-600 flex items-center justify-center transition"><i class="fa-solid fa-trash text-[10px]"></i></button>
                        </div>
                    </div>
                `).join('');
            },

            updateRank(count) {
                let rank = CONFIG.RANKS[0];
                if(count > 10) rank = CONFIG.RANKS[1];
                if(count > 30) rank = CONFIG.RANKS[2];
                if(count > 100) rank = CONFIG.RANKS[3];
                if(count > 500) rank = CONFIG.RANKS[4];
                
                document.getElementById('user-rank').innerText = rank + " Learner";
                const statRank = document.getElementById('stat-rank');
                if(statRank) statRank.innerText = rank;
                document.getElementById('stat-total').innerText = count;
            }
        };

        /**
         * AUTHENTICATION MODULE
         * @namespace Handles Encryption & Session
         */
        const auth = {
            signup() {
                const u = document.getElementById('s-user').value.trim();
                const p = document.getElementById('s-pass').value;
                
                if(u.length < 3 || p.length < 6) return alert("Username > 3, Password > 6 ký tự!");
                
                const db = JSON.parse(localStorage.getItem('lingopro_db') || '[]');
                if(db.some(x => x.username === u)) return alert("User đã tồn tại!");
                
                // SHA-256 Encryption
                const hashedPassword = CryptoJS.SHA256(p + CONFIG.HASH_KEY).toString();
                
                db.push({
                    username: u,
                    password: hashedPassword,
                    vocab: [],
                    created_at: new Date().toISOString()
                });
                
                localStorage.setItem('lingopro_db', JSON.stringify(db));
                alert("Đăng ký thành công! Vui lòng đăng nhập.");
                ui.toggleAuthMode('login');
            },

            login() {
                const u = document.getElementById('l-user').value;
                const p = document.getElementById('l-pass').value;
                const db = JSON.parse(localStorage.getItem('lingopro_db') || '[]');
                
                const hashedPassword = CryptoJS.SHA256(p + CONFIG.HASH_KEY).toString();
                const found = db.find(x => x.username === u && x.password === hashedPassword);
                
                if(found) {
                    state.user = { username: found.username, token: Date.now() };
                    localStorage.setItem('lingopro_session', JSON.stringify(state.user));
                    location.reload();
                } else {
                    alert("Sai tên đăng nhập hoặc mật khẩu!");
                }
            },

            logout() {
                localStorage.removeItem('lingopro_session');
                location.reload();
            }
        };

        /**
         * MAIN APP LOGIC
         * @namespace Core engine features
         */
        const app = {
            ytPlayer: null,

            processLyrics() {
                const text = document.getElementById('lyric-input').value.trim();
                const ytUrl = document.getElementById('yt-url').value;
                
                if(!text) return alert("Vui lòng nhập nội dung!");

                // Handle YouTube
                const vid = ytUrl.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
                if(vid) {
                    if(this.ytPlayer) {
                        this.ytPlayer.loadVideoById(vid[1]);
                    } else {
                        this.ytPlayer = new YT.Player('player', {
                            videoId: vid[1],
                            playerVars: { 'autoplay': 1, 'modestbranding': 1 }
                        });
                    }
                }

                this.renderClassroom(text);
                document.getElementById('reading-time').innerText = Math.ceil(text.split(' ').length / 200);
            },

            renderClassroom(text) {
                const container = document.getElementById('lyric-display');
                container.innerHTML = "";
                
                text.split('\n').forEach(line => {
                    if(!line.trim()) return;
                    const row = document.createElement('div');
                    row.className = "lyric-line px-4 rounded-xl transition hover:bg-white/5 group";
                    
                    line.split(/\s+/).forEach(word => {
                        const span = document.createElement('span');
                        span.className = "word word-glow inline-block cursor-pointer mr-1.5 transition";
                        span.innerText = word;
                        span.onclick = (e) => this.translate(word.replace(/[.,!?;:]/g, ""), e);
                        row.appendChild(span);
                    });
                    container.appendChild(row);
                });
                
                gsap.from(".lyric-line", { opacity: 0, x: -20, stagger: 0.1, duration: 0.8 });
            },

            async translate(word, e) {
                const target = document.getElementById('target-lang').value;
                document.getElementById('pop-src').innerText = word;
                document.getElementById('pop-vi').innerText = "...";
                ui.showPopup();

                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${target}&dt=t&q=${encodeURIComponent(word)}`);
                    const data = await res.json();
                    const result = data[0][0][0];
                    state.currentWord = { src: word, vi: result };
                    document.getElementById('pop-vi').innerText = result;
                } catch (err) {
                    document.getElementById('pop-vi').innerText = "Lỗi kết nối";
                }
            },

            saveVocab() {
                if(!state.user) return ui.toggleModal('auth-modal', 'login');
                if(!state.currentWord) return;
                
                if(state.notebook.some(x => x.src.toLowerCase() === state.currentWord.src.toLowerCase())) {
                    return alert("Từ này đã có trong Notebook!");
                }

                state.notebook.unshift({...state.currentWord});
                this.syncDB();
                ui.renderNotebook();
                ui.updateRank(state.notebook.length);
                ui.closePopup();
            },

            deleteVocab(idx) {
                state.notebook.splice(idx, 1);
                this.syncDB();
                ui.renderNotebook();
            },

            syncDB() {
                const db = JSON.parse(localStorage.getItem('lingopro_db') || '[]');
                const uIdx = db.findIndex(u => u.username === state.user.username);
                if(uIdx !== -1) {
                    db[uIdx].vocab = state.notebook;
                    localStorage.setItem('lingopro_db', JSON.stringify(db));
                }
            },

            speakText(text) {
                const msg = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(msg);
            },
            
            speak() { if(state.currentWord) this.speakText(state.currentWord.src); },

            // STATS ENGINE
            initStats() {
                const ctx = document.getElementById('mainChart').getContext('2d');
                if(state.chart) state.chart.destroy();
                
                state.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Vocabulary Growth',
                            data: [0, 2, 5, state.notebook.length - 2, state.notebook.length - 1, state.notebook.length, state.notebook.length],
                            borderColor: '#6366f1',
                            tension: 0.4,
                            fill: true,
                            backgroundColor: 'rgba(99, 102, 241, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                            x: { grid: { display: false }, ticks: { color: '#64748b' } }
                        }
                    }
                });
            },

            // QUIZ ENGINE
            openQuiz() {
                if(state.notebook.length < 4) return alert("Cần ít nhất 4 từ vựng để bắt đầu!");
                ui.toggleModal('quiz-modal');
                document.getElementById('quiz-intro').classList.remove('hidden');
                document.getElementById('quiz-engine').classList.add('hidden');
            },

            startQuiz() {
                state.quiz.score = 0;
                state.quiz.index = 0;
                document.getElementById('quiz-intro').classList.add('hidden');
                document.getElementById('quiz-engine').classList.remove('hidden');
                this.nextQuestion();
            },

            nextQuestion() {
                if(state.quiz.index >= 10) return this.endQuiz();
                
                state.quiz.index++;
                const correct = state.notebook[Math.floor(Math.random() * state.notebook.length)];
                let options = [correct.vi];
                
                while(options.length < 4) {
                    const rand = state.notebook[Math.floor(Math.random() * state.notebook.length)].vi;
                    if(!options.includes(rand)) options.push(rand);
                }
                options.sort(() => Math.random() - 0.5);

                document.getElementById('quiz-progress').innerText = `QUESTION ${state.quiz.index}/10`;
                document.getElementById('quiz-q-word').innerText = correct.src;
                document.getElementById('quiz-options').innerHTML = options.map(opt => `
                    <button onclick="app.checkAnswer('${opt}', '${correct.vi}')" class="glass p-5 rounded-2xl hover:bg-indigo-600 font-bold transition-all hover:scale-[1.02]">${opt}</button>
                `).join('');
            },

            checkAnswer(selected, correct) {
                if(selected === correct) {
                    state.quiz.score += 10;
                    document.getElementById('quiz-score').innerText = `SCORE: ${state.quiz.score}`;
                }
                this.nextQuestion();
            },

            endQuiz() {
                alert(`Assessment Finished! Your Score: ${state.quiz.score}/100`);
                ui.closeModal('quiz-modal');
            },

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.notebook));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `lingopro_backup_${state.user.username}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }
        };

        // Event Listeners
        document.getElementById('process-btn').onclick = () => app.processLyrics();
        
        // Init On Load
        window.onload = () => ui.init();
    </script>
</body>
</html>
