<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoMusic - True Hunter Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .active-line { 
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa !important;
            border-left: 4px solid #3b82f6;
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .lyrics-line { padding: 18px; border-radius: 12px; margin-bottom: 10px; transition: all 0.3s ease; border-left: 4px solid transparent; cursor: pointer; }
        #video-stage { border-radius: 2rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="p-6 lg:p-12">

    <div class="max-w-[1600px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <h1 class="text-3xl font-black tracking-tighter text-blue-500">LINGOMUSIC <span class="text-white font-light">HUNTER</span></h1>
            <div class="flex gap-2 w-full md:w-[600px] bg-slate-900 p-2 rounded-2xl border border-slate-800">
                <input type="text" id="videoUrl" placeholder="Dán link bài hát bất kỳ vào đây..." 
                       class="flex-1 bg-transparent px-4 py-2 outline-none text-white">
                <button onclick="huntLyrics()" class="bg-blue-600 hover:bg-blue-700 px-8 py-3 rounded-xl font-bold transition-all">SĂN LỜI</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <div class="lg:col-span-7">
                <div id="video-stage" class="aspect-video bg-black shadow-2xl">
                    <div id="player"></div>
                </div>
                <div id="status-bar" class="mt-6 p-4 bg-slate-900/50 rounded-xl text-sm text-slate-400 flex items-center gap-3">
                    <i class="fas fa-satellite-dish animate-pulse text-blue-500"></i>
                    <span>Sẵn sàng nhận tín hiệu...</span>
                </div>
            </div>

            <div class="lg:col-span-5">
                <div class="bg-slate-900/80 rounded-[2.5rem] h-[700px] flex flex-col overflow-hidden border border-slate-800 shadow-xl">
                    <div id="lyricsContent" class="flex-1 overflow-y-auto p-6 space-y-2 custom-scrollbar">
                        <div class="text-center py-32 opacity-20">
                            <i class="fas fa-search text-6xl mb-4"></i>
                            <p>Hệ thống sẽ tự động tìm lời và khớp nhạc cho bạn.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        let player, lyricsData = [], syncTimer;

        async function huntLyrics() {
            const url = document.getElementById('videoUrl').value;
            const id = extractId(url);
            if (!id) return alert("Link không hợp lệ!");

            updateStatus("Đang truy quét dữ liệu YouTube...", "loading");

            // 1. Khởi tạo Player trước để lấy Duration
            if (player) player.destroy();
            player = new YT.Player('player', {
                videoId: id,
                events: { 
                    'onReady': async (e) => {
                        const duration = e.target.getDuration();
                        await processLyrics(id, duration);
                        e.target.playVideo();
                    },
                    'onStateChange': onStateChange 
                }
            });
        }

        async function processLyrics(id, duration) {
            try {
                // Thử lấy phụ đề thật (Khớp 100%)
                const res = await fetch(`https://sub-api-endpoint.vercel.app/api/transcript?v=${id}`);
                if (!res.ok) throw new Error("No CC");
                lyricsData = await res.json();
                updateStatus("Đã lấy được phụ đề gốc từ YouTube!", "success");
            } catch (err) {
                // Nếu không có phụ đề, ta dùng thuật toán "Săn lời & Chia nhịp"
                updateStatus("Video không có phụ đề. Đang tự động quét lời từ thư viện...", "warning");
                
                // Giả lập việc quét lời từ API Lyrics bên ngoài
                const lyricsText = await fetchExternalLyrics(id); 
                const lines = lyricsText.split('\n').filter(l => l.trim());
                const interval = duration / lines.length;
                
                lyricsData = lines.map((t, i) => ({
                    s: (i * interval) + (interval * 0.1), // Căn lề thời gian
                    t: t
                }));
            }

            // Dịch toàn bộ
            for (let line of lyricsData) {
                line.v = await translateText(line.t);
            }
            renderLyrics();
        }

        async function translateText(text) {
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=vi&dt=t&q=${encodeURI(text)}`);
                const data = await res.json();
                return data[0][0][0];
            } catch { return "..."; }
        }

        // Hàm giả lập "đi săn" lời từ các trang web Lyrics
        async function fetchExternalLyrics(id) {
            // Trong thực tế, bạn có thể kết nối với API của Genius hoặc Musixmatch
            // Ở đây mình trả về một đoạn thông báo để bạn dán lời vào nếu AI không tìm thấy
            return "Hệ thống không tìm thấy phụ đề có sẵn.\nVui lòng dán lời bài hát vào ô dưới đây để mình khớp cho bạn nhé!\n(Hoặc chọn video khác có CC)";
        }

        function renderLyrics() {
            const container = document.getElementById('lyricsContent');
            container.innerHTML = lyricsData.map((l, i) => `
                <div id="line-${i}" onclick="player.seekTo(${l.s})" class="lyrics-line">
                    <p class="font-bold text-lg text-slate-100">${l.t}</p>
                    <p class="text-blue-400 text-sm mt-1 italic">${l.v}</p>
                </div>
            `).join('');
        }

        function onStateChange(e) {
            if (e.data == YT.PlayerState.PLAYING) {
                syncTimer = setInterval(() => {
                    const now = player.getCurrentTime();
                    lyricsData.forEach((line, i) => {
                        const el = document.getElementById(`line-${i}`);
                        if (now >= line.s && (i === lyricsData.length - 1 || now < lyricsData[i+1].s)) {
                            document.querySelectorAll('.lyrics-line').forEach(l => l.classList.remove('active-line'));
                            if (el) {
                                el.classList.add('active-line');
                                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    });
                }, 200);
            } else { clearInterval(syncTimer); }
        }

        function updateStatus(msg, type) {
            const bar = document.getElementById('status-bar');
            bar.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
        }

        function extractId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length == 11) ? match[2] : false;
        }
    </script>
</body>
</html>
